{% extends 'admin_base.html' %}
{% load static %}
{% block title %}周辺MAP登録{% endblock %}
{% block content %}


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  .wrap{display:flex; gap:24px; align-items:flex-start;}
  #map{width:400px;height:320px;background:#dff2d8;border:1px solid #aaa;}
  .side{min-width:320px;}
  .icon-list{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
  .icon-btn{padding:14px; border:1px solid #aaa; cursor:pointer; background:#fff; text-align:center;}
  .icon-btn.active{outline:3px solid #ff5a5a;}
  .actions{margin-top:16px; display:flex; gap:10px;}
  .hint{font-size:12px; opacity:.8; margin-top:6px;}
  .warn{color:#c00; font-size:12px; margin-top:8px; display:none;}
</style>

<div class="content-container basic-info-list">
  <h1>周辺MAP登録</h1>
  <hr style="width:80%; margin-bottom: 10px; margin-top: 10px;">

  {% if form.errors %}
  <div style="color:red; margin-bottom:12px;">
    <div>入力に誤りがあります。確認してください。</div>
    {{ form.non_field_errors }}
    {% for field in form %}
      {% for error in field.errors %}
        <div>{{ field.label }}：{{ error }}</div>
      {% endfor %}
    {% endfor %}
  </div>
{% endif %}
  <div class="wrap">
    <!-- 左：地図 -->
    <div>
      <div id="map"></div>
      <div class="hint">①カテゴリを選ぶ → ②地図をクリックで設置 → ③登録</div>
      <div id="warn" class="warn">※地図をクリックして位置を指定してください</div>
    </div>

    <!-- 右：カテゴリ -->
    <div class="side">
      <form method="post" enctype="multipart/form-data" id="regForm">
        {% csrf_token %}
        <input type="hidden" name="pins_json" id="pins_json">


        <!-- hidden（forms.pyでHiddenInputにしてる前提） -->
        {{ form.latitude }}{{ form.longitude }}

        <!-- icon_name は hidden化してボタンで選択 -->
        <div style="display:none;">{{ form.icon_name }}</div>

        <div style="font-weight:bold;">カテゴリ</div>
        <div class="icon-list">
          <div class="icon-btn active" data-value="QR">QR</div>
          <div class="icon-btn" data-value="トイレ">トイレ</div>
          <div class="icon-btn" data-value="見どころポイント">見どころポイント</div>
          <div class="icon-btn" data-value="バリアフリー情報">バリアフリー情報</div>
        </div>

        <div style="margin-top:12px;">
          <div>アイコン画像（任意）</div>
          {{ form.icon_image }}
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-register">登録</button>
          <a class="btn btn-cancel" href="{% url 'admin_area_map:area_map_detail' basic_info_id %}">戻る</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const map = L.map('map').setView([{{ map_center.lat }}, {{ map_center.lng }}], {{ map_center.zoom }});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  // hidden input（nameで取る）
  const latEl = document.querySelector('input[name="latitude"]');
  const lngEl = document.querySelector('input[name="longitude"]');
  const iconSelect = document.querySelector('[name="icon_name"]');
  const pinsJsonEl = document.getElementById("pins_json");
  const warnEl = document.getElementById("warn");

  // ★カテゴリ既定アイコン（static/image 直下）
  const DEFAULT_ICON_URL = {
    "QR": "{% static 'image/qr.webp' %}",
    "トイレ": "{% static 'image/toilet.webp' %}",
    "見どころポイント": "{% static 'image/spot.jpeg' %}",
    "バリアフリー情報": "{% static 'image/barrierfree.jpg' %}",
  };

  // 置いた仮ピンを全部保持
  // ※previewUrl は「仮ピンに使った画像URL」
  const markers = []; // { layer, category, lat, lng, previewUrl }

  function getCurrentCategory(){
    return (iconSelect && iconSelect.value) ? iconSelect.value : "QR";
  }

  // ★pins_json を常に更新
  function syncPinsJson(){
    if (!pinsJsonEl) return;
    pinsJsonEl.value = JSON.stringify(
      markers.map(x => ({ category: x.category, lat: x.lat, lng: x.lng }))
    );
  }

  // ★「カテゴリ画像」の Leaflet Icon を作る
  function makeCategoryIcon(category){
    const url = DEFAULT_ICON_URL[category] || DEFAULT_ICON_URL["QR"];
    return L.icon({
      iconUrl: url,
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -28],
    });
  }

  function addTempPin(lat, lng){
    const category = getCurrentCategory();

    // ★カテゴリ画像ピンで置く
    const icon = makeCategoryIcon(category);
    const layer = L.marker([lat, lng], { icon }).addTo(map);

    layer.bindPopup(category);

    markers.push({
      layer,
      category,
      lat,
      lng,
      previewUrl: (DEFAULT_ICON_URL[category] || "")
    });

    // （任意）最後に置いた座標を hidden に入れておく（既存のまま）
    if (latEl) latEl.value = lat;
    if (lngEl) lngEl.value = lng;

    syncPinsJson();
    if (warnEl) warnEl.style.display = "none";
  }

  // 地図クリックで追加
  map.on("click", e => addTempPin(e.latlng.lat, e.latlng.lng));

  // --- カテゴリボタン ---
  const buttons = document.querySelectorAll(".icon-btn");
  function activate(value){
    buttons.forEach(b => b.classList.toggle("active", b.dataset.value === value));
    if (iconSelect) iconSelect.value = value;
  }
  buttons.forEach(btn => btn.addEventListener("click", () => activate(btn.dataset.value)));
  activate("QR");

  // --- 右クリックで最後を取り消し ---
  map.on("contextmenu", () => {
    const last = markers.pop();
    if (last) {
      map.removeLayer(last.layer);
      syncPinsJson();
    }
  });

  // --- 登録前チェック ---
  document.getElementById("regForm").addEventListener("submit", (e) => {
    if (markers.length === 0) {
      e.preventDefault();
      if (warnEl) warnEl.style.display = "block";
      return;
    }
    syncPinsJson();
  });
</script>



{% endblock %}