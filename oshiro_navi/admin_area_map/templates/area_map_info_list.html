{% extends 'admin_base.html' %}
{% load static %}
{% block title %}周辺MAP一覧{% endblock %}
{% block content %}



<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  .wrap{display:flex; gap:24px; align-items:flex-start;}
  #map{width:400px;height:320px;background:#dff2d8;border:1px solid #aaa;}
  .side{min-width:320px;}
  .icon-list{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
  .icon-btn{padding:10px; border:1px solid #aaa; cursor:pointer; background:#fff;}
  .icon-btn.active{outline:3px solid #ff5a5a;}
  .top-actions{display:flex; align-items:center; gap:12px;}
  .hint{font-size:12px; opacity:.8; margin-top:6px;}
</style>

<div class="content-container basic-info-list">
  <h1>周辺MAP一覧</h1>
  <hr style="width:80%; margin-bottom: 10px; margin-top: 10px;">
  <div class="top-actions">
    <a href="{% url 'admin_area_map:area_map_info_registar' basic_info_id %}" class="btn btn-register">周辺MAP登録</a>
    <a href="{% url 'admin_area_map:area_map' %}" class="btn btn-cancel">戻る</a>
  </div>



  <div class="wrap">
    <div>
      <div id="map"></div>
      <div class="hint" style="color: red;">※ピンをクリックすると更新ページへ移動します</div>
    </div>

    <div class="side">
      <div style="font-weight:bold;">カテゴリ</div>
      <div class="icon-list">
        <div class="icon-btn active" data-filter="ALL">すべて</div>
        <div class="icon-btn" data-filter="QR">QR</div>
        <div class="icon-btn" data-filter="トイレ">トイレ</div>
        <div class="icon-btn" data-filter="見どころポイント">見どころポイント</div>
        <div class="icon-btn" data-filter="バリアフリー情報">バリアフリー情報</div>
      </div>
    </div>
  </div>
</div>

<!-- ★JSONはscriptタグに埋める（安全） -->
<script id="maps-data" type="application/json">{{ maps_json|safe }}</script>

<script>
  const map = L.map('map').setView([{{ map_center.lat }}, {{ map_center.lng }}], {{ map_center.zoom }});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  const DEFAULT_ICON_URL = {
    "QR": "{% static 'image/qr.webp' %}",
    "トイレ": "{% static 'image/toilet.webp' %}",
    "見どころポイント": "{% static 'image/spot.jpeg' %}",
    "バリアフリー情報": "{% static 'image/barrierfree.jpg' %}",
  };

  const CATEGORY_STYLE = {
    "QR": { color:"#1f78ff", fillColor:"#1f78ff" },
    "トイレ": { color:"#2ea043", fillColor:"#2ea043" },
    "見どころポイント": { color:"#ff8c00", fillColor:"#ff8c00" },
    "バリアフリー情報": { color:"#8a2be2", fillColor:"#8a2be2" },
  };

  function resolveImageUrl(iconName, imageUrlFromDB){
    if (imageUrlFromDB && imageUrlFromDB.trim() !== "") return imageUrlFromDB.trim();
    return DEFAULT_ICON_URL[iconName] || "";
  }

  function makeLayer(lat, lng, iconName, imageUrlFromDB){
    const imageUrl = resolveImageUrl(iconName, imageUrlFromDB);

    if (imageUrl) {
      const icon = L.icon({
        iconUrl: imageUrl,
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -28],
      });
      return L.marker([lat, lng], { icon });
    }

    const style = CATEGORY_STYLE[iconName] || { color:"#333", fillColor:"#333" };
    return L.circleMarker([lat, lng], { radius: 10, weight: 3, opacity: 1, fillOpacity: 0.85, ...style });
  }

  // ★表ではなく JSON から読む
  const maps = JSON.parse(document.getElementById("maps-data").textContent);

  const items = []; // { layer, iconName }
  maps.forEach(m => {
    const layer = makeLayer(m.lat, m.lng, m.icon_name, m.image_url).addTo(map);
    layer.bindPopup(m.icon_name);
    layer.on("click", () => window.location.href = m.update_url);
    items.push({ layer, iconName: m.icon_name });
  });

  // ピンがあるなら、最初にいい感じに寄せる
  if (items.length > 0) {
    const group = L.featureGroup(items.map(x => x.layer));
    map.fitBounds(group.getBounds().pad(0.2));
  }

  function applyFilter(value){
    items.forEach(x => {
      const ok = (value === "ALL") || (x.iconName === value);
      if (ok) {
        if (!map.hasLayer(x.layer)) x.layer.addTo(map);
      } else {
        if (map.hasLayer(x.layer)) map.removeLayer(x.layer);
      }
    });
  }

  // カテゴリボタン
  const btns = document.querySelectorAll(".icon-btn");
  btns.forEach(btn => {
    btn.addEventListener("click", () => {
      btns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      applyFilter(btn.dataset.filter);
    });
  });

  applyFilter("ALL");
</script>



{% endblock %}
