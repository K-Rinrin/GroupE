{% extends "user_base.html" %}
{% load static %}

{% block title %}お城スタンプ帳{% endblock %}

{% block content %}

<div class="stamp-book-container">
    <div class="stamp-header">
        <h1>お城スタンプ</h1>
        <div>獲得数: <b>{{ total_count }}</b> / 18</div>
    </div>

    <div class="btn-group-top">
        <button id="get-stamp-btn" class="btn-get-stamp">スタンプを登録する</button>
    </div>

    <div class="stamp-main-area">
        <a href="?page={{ prev_page }}" class="nav-arrow {% if current_page <= 1 %}disabled{% endif %}">❮</a>

        <div class="stamp-grid">
            {% for stamp in stamps_on_page %}
            <div class="stamp-box">
                <div class="castle-name">{{ stamp.oshiro_stamp_info.oshiro_info.oshiro_name }}</div>
                <div class="stamp-image-wrap" onclick="openModal(this)">
                    {% if stamp.oshiro_stamp_info.oshiro_stamp_image %}
                        <img src="{{ stamp.oshiro_stamp_info.oshiro_stamp_image.url }}" alt="stamp">
                    {% endif %}
                </div>
                <div class="stamp-date">{{ stamp.date|date:"Y.n.j" }}</div>
            </div>
            {% endfor %}

            {% for i in range_remaining %}
            <div class="stamp-box empty"></div>
            {% endfor %}
        </div>

        <a href="?page={{ next_page }}" class="nav-arrow {% if current_page >= 3 %}disabled{% endif %}">❯</a>
    </div>

    <div class="page-indicator">{{ current_page }} / 3 ページ</div>

    <div style="text-align: center; margin-top: 40px;">
        <a href="{% url 'usermy_page:mypage' %}" style="color: #333; font-weight: bold;">マイページに戻る</a>
    </div>
</div>

<div id="image-modal" onclick="closeModal()">
    <span class="close-modal">&times;</span>
    <img id="modal-img">
</div>

<script>
    // モーダル開閉
    function openModal(element) {
        const imgTag = element.querySelector('img');
        if (!imgTag) return;
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-img');
        modal.style.display = "flex";
        modalImg.src = imgTag.src;
    }
    function closeModal() {
        document.getElementById('image-modal').style.display = "none";
    }

    // スタンプ登録処理
    document.getElementById('get-stamp-btn').addEventListener('click', function() {
        const btn = this;
        if (!navigator.geolocation) {
            alert("お使いの端末はGPSに対応していません");
            return;
        }
        
        btn.disabled = true;
        btn.innerText = "位置情報を確認中...";

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const formData = new FormData();
                formData.append('latitude', pos.coords.latitude);
                formData.append('longitude', pos.coords.longitude);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                fetch("{% url 'usermy_page:get_stamp' %}", {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    if (data.status === 'success') {
                        location.reload();
                    }
                    btn.disabled = false;
                    btn.innerText = "スタンプを登録する";
                })
                .catch(err => {
                    alert("通信エラーが発生しました");
                    btn.disabled = false;
                    btn.innerText = "スタンプを登録する";
                });
            },
            (err) => {
                alert("位置情報の取得に失敗しました。GPSをオンにしてください。");
                btn.disabled = false;
                btn.innerText = "スタンプを登録する";
            }
        );
    });
</script>
{% endblock %}