{% extends "user_base.html" %}
{% load static %}

{% block title %}{{ oshiro.oshiro_name }} - 周辺MAP{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="container">
    
    <div class="oshiro-image-header">
        {% if oshiro.info.oshiro_images or oshiro.oshiro_images %}
            <img src="{% if oshiro.info.oshiro_images %}{{ oshiro.info.oshiro_images.url }}{% else %}{{ oshiro.oshiro_images.url }}{% endif %}" alt="{{ oshiro.oshiro_name }}">
        {% endif %}
        <div class="header-overlay">
            <h1>{{ oshiro.oshiro_name }}</h1>
        </div>
    </div>

    <div class="info-tabs">
        <a href="{% url 'usermy_list:oshiroinfo' oshiro.id %}" class="tab-item">お城情報</a>
        <a href="{% url 'usermy_list:oshirobasicinfo' oshiro.id %}" class="tab-item">基本情報</a>
        <a href="{% url 'usermy_list:oshiroreview' oshiro.id %}" class="tab-item">口コミ</a>
        <a href="{% url 'usermy_list:oshiromap' oshiro.id %}" class="tab-item active">周辺MAP</a>
    </div>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<div class="map-content-area">
    <div class="side-panel">
        <div class="category-list">
            <button class="cat-btn active" data-cat="すべて">
                <span class="material-symbols-outlined">map</span>
                すべて
            </button>
            <button class="cat-btn" data-cat="QR">
                <span class="material-symbols-outlined">qr_code_scanner</span>
                QR
            </button>
            <button class="cat-btn" data-cat="トイレ">
                <span class="material-symbols-outlined">wc</span>
                トイレ
            </button>
            <button class="cat-btn" data-cat="見どころポイント">
                <span class="material-symbols-outlined">visibility</span>
                見どころ
            </button>
            <button class="cat-btn" data-cat="バリアフリー情報">
                <span class="material-symbols-outlined">accessible</span>
                バリアフリー
            </button>
        </div>
    </div>

    <div id="map"></div>
</div>
</div>

<script>
  const oshiroLat = {{ oshiro.latitude|default:35.6895 }};
  const oshiroLng = {{ oshiro.longitude|default:139.6917 }};

  const map = L.map('map').setView([oshiroLat, oshiroLng], 16);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

  const pinsData = {{ pins_json|safe }};
  const markers = [];

  pinsData.forEach(pin => {
    let marker;
    if (pin.image) {
      const customIcon = L.icon({
        iconUrl: pin.image,
        iconSize: [40, 40],
        iconAnchor: [20, 20],
        popupAnchor: [0, -20],
        className: 'custom-map-icon'
      });
      marker = L.marker([pin.lat, pin.lng], { icon: customIcon });
    } else {
      marker = L.marker([pin.lat, pin.lng]);
    }
    marker.bindPopup(`<strong>${pin.name}</strong>`);
    marker.addTo(map);
    markers.push({ instance: marker, category: pin.category });
  });

  const buttons = document.querySelectorAll('.cat-btn');
  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      buttons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const selectedCat = btn.getAttribute('data-cat');
      markers.forEach(m => {
        if (selectedCat === 'すべて' || m.category === selectedCat) {
          m.instance.addTo(map);
        } else {
          map.removeLayer(m.instance);
        }
      });
    });
  });
</script>
{% endblock %}