{% extends "user_base.html" %}
{% load static %}

{% block title %}{{ oshiro.oshiro_name }} - å£ã‚³ãƒŸ{% endblock %}

{% block content %}

<div class="container" style="max-width: 800px; margin: 30px auto; background: #fff; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
    
    <div class="oshiro-image-header" style="width: 100%; height: 350px; overflow: hidden; position: relative; background: #eee;">
        {% if oshiro.info.oshiro_images %}
            <img src="{{ oshiro.info.oshiro_images.url }}" style="width: 100%; height: 100%; object-fit: cover;">
        {% elif oshiro.oshiro_images %}
            <img src="{{ oshiro.oshiro_images.url }}" style="width: 100%; height: 100%; object-fit: cover;">
        {% else %}
             <div style="text-align: center; padding-top: 150px; color: #aaa;">No Image Available</div>
        {% endif %}
        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: 40px 20px 20px;">
            <h1 style="color: white; margin: 0; font-size: 2em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">{{ oshiro.oshiro_name }}</h1>
        </div>
    </div>

    <div class="info-tabs" style="display: flex; border-bottom: 2px solid #eee; background: #fdfdfd;">
        <a href="{% url 'usermy_list:oshiroinfo' oshiro.id %}" class="tab-item" style="flex: 1; text-align: center; padding: 15px; text-decoration: none; color: #888; font-weight: bold;">ãŠåŸæƒ…å ±</a>
        <a href="{% url 'usermy_list:oshirobasicinfo' oshiro.id %}" class="tab-item" style="flex: 1; text-align: center; padding: 15px; text-decoration: none; color: #888; font-weight: bold;">åŸºæœ¬æƒ…å ±</a>
        <a href="{% url 'usermy_list:oshiroreview' oshiro.id %}" class="tab-item" style="flex: 1; text-align: center; padding: 15px; text-decoration: none; color: #d9534f; border-bottom: 3px solid #d9534f; font-weight: bold;">å£ã‚³ãƒŸ</a>
        <a href="{% url 'usermy_list:oshiromap' oshiro.id %}" class="tab-item" style="flex: 1; text-align: center; padding: 15px; text-decoration: none; color: #888; font-weight: bold;">å‘¨è¾ºMAP</a>
    </div>

    <div class="info-content" style="padding: 40px 50px;">
        
        <div style="margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
            <h2 style="font-size: 1.2em; border-left: 5px solid #d9534f; padding-left: 10px; margin-bottom: 15px; color: #333;">ã¿ã‚“ãªã®è©•ä¾¡</h2>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 2em; color: #f39c12; font-weight: bold;">â˜… {{ avg_score }}</span>
                <span style="color: #666;">ï¼ˆå…¨ {{ reviews.count }} ä»¶ï¼‰</span>
            </div>
        </div>

        <div style="margin-bottom: 50px; background: #fafafa; padding: 25px; border-radius: 10px; border: 1px solid #eee;">
            {# æŠ•ç¨¿æ¸ˆã¿ ã‹ã¤ æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ã§ãªã„æ™‚ã ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™ #}
            {% if has_posted and not edit_mode %}
                <div style="text-align: center; padding: 20px; color: #666;">
                    <p style="font-weight: bold; margin-bottom: 10px;">æ—¢ã«å£ã‚³ãƒŸã‚’æŠ•ç¨¿æ¸ˆã¿ã§ã™ã€‚</p>
                    <p style="font-size: 0.9em;">å†…å®¹ã‚’ä¿®æ­£ã—ãŸã„å ´åˆã¯ã€ã”è‡ªèº«ã®æŠ•ç¨¿ã«ã‚ã‚‹ã€Œæ›´æ–°ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            {% else %}
                <h3 style="font-size: 1.1em; margin-bottom: 20px; color: #555;">
                    {% if edit_mode %}å£ã‚³ãƒŸã‚’æ›´æ–°ã™ã‚‹{% else %}ãŠåŸå£ã‚³ãƒŸã‚’æŠ•ç¨¿ã™ã‚‹{% endif %}
                </h3>
                
                {# actionã«edit_idã‚’å«ã‚ã‚‹ã“ã¨ã§æ›´æ–°ã‚’è­˜åˆ¥ã™ã‚‹ #}
                <form method="post" enctype="multipart/form-data" action="?{% if edit_id %}edit_id={{ edit_id }}{% endif %}">
                    {% csrf_token %}
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px;">â€» ã‚¿ã‚¤ãƒˆãƒ«</label>
                        {{ form.review_title }}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px;">â€» è©•ä¾¡</label>
                        <div id="star-rating" style="font-size: 2em; color: #ccc; cursor: pointer; display: inline-block;">
                            <span class="star" data-value="1">â˜†</span><span class="star" data-value="2">â˜†</span><span class="star" data-value="3">â˜†</span><span class="star" data-value="4">â˜†</span><span class="star" data-value="5">â˜†</span>
                        </div>
                        {# JavaScriptã§æ˜Ÿã‚’å…¥ã‚Œã‚‹ãŸã‚éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦æ‰±ã†ã®ãŒä¸€èˆ¬çš„ã§ã™ãŒã€ãã®ã¾ã¾ã«ã—ã¦ã„ã¾ã™ #}
                        {{ form.five_star_review }}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px;">â€» ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                        {{ form.review_comments }}
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px;">å†™çœŸ</label>
                        {{ form.review_image }}
                    </div>
                    
                    <button type="submit" style="background: #333; color: white; border: none; padding: 10px 30px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                        {% if edit_mode %}æ›´æ–°ã‚’ä¿å­˜ã™ã‚‹{% else %}æŠ•ç¨¿ã™ã‚‹{% endif %}
                    </button>
                    
                    {% if edit_mode %}
                        <a href="?" style="margin-left: 15px; color: #666; font-size: 0.9em; text-decoration: none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
                    {% endif %}
                </form>
            {% endif %}
        </div>

        <h2 style="font-size: 1.2em; border-left: 5px solid #d9534f; padding-left: 10px; margin-bottom: 20px; color: #333;">æŠ•ç¨¿ã•ã‚ŒãŸãŠåŸå£ã‚³ãƒŸ</h2>
        {% for review in reviews %}
            <div style="border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 5px; background: #fff;">
                <div style="display: flex; gap: 15px;">
                    <div style="flex-shrink: 0;">
                        {% if review.user.profile_image %}
                            <img src="{{ review.user.profile_image.url }}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 1px solid #eee;">
                        {% else %}
                            <div style="width: 50px; height: 50px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">
                                ğŸ‘¤
                            </div>
                        {% endif %}
                    </div>

                    <div style="flex-grow: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <div style="font-weight: bold; color: #333;">{{ review.user.account.username }}ã•ã‚“</div>
                            <div style="font-size: 0.85em; color: #999;">{{ review.post_date_time|date:"Y.m.d" }}</div>
                        </div>

                        <div style="color: #f39c12; margin-bottom: 10px;">
                            {% with ''|center:review.five_star_review as range %}
                                {% for _ in range %}â˜…{% endfor %}
                            {% endwith %}
                        </div>

                        <strong style="display: block; margin-bottom: 5px; font-size: 1.1em;">{{ review.review_title }}</strong>
                        <p style="color: #444; line-height: 1.6; margin-bottom: 10px;">{{ review.review_comments|linebreaksbr }}</p>

                        {% if review.review_image %}
                            <img src="{{ review.review_image.url }}" style="max-width: 100%; max-height: 250px; border-radius: 5px; margin-top: 5px;">
                        {% endif %}

                        {% if review.user.account == user %}
                            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #eee; text-align: right;">
                                {# â˜…ä¿®æ­£ï¼šhrefã‚’ "?edit_id={{ review.pk }}" ã«å¤‰æ›´ #}
                                <a href="?edit_id={{ review.pk }}" style="display: inline-block; padding: 3px 12px; border: 2px solid #000; text-decoration: none; color: #000; font-size: 0.85em; margin-right: 10px; font-weight: bold; background: #fff;">
                                    æ›´æ–°ã™ã‚‹
                                </a>
                                
                                <a href="{% url 'usermy_list:delete_review' review.pk %}" 
                                   onclick="return confirm('æœ¬å½“ã«ã“ã®å£ã‚³ãƒŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')" 
                                   style="display: inline-block; padding: 3px 12px; border: 2px solid #000; text-decoration: none; color: #fff; background: #000; font-size: 0.85em; font-weight: bold;">
                                    å‰Šé™¤ã™ã‚‹
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div style="margin-top: 30px; text-align: center;">
                <a href="{% url 'usermy_list:oshiroreview' oshiro.id %}" style="color: #999; text-decoration: none; font-size: 0.8em; border: 1px solid #eee; padding: 5px 15px; border-radius: 20px;">â† æˆ»ã‚‹</a>
            </div>
            </div>
        {% empty %}
            <p style="text-align: center; color: #999;">ã¾ã å£ã‚³ãƒŸã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endfor %}
    </div>
</div>

<script>
    const stars = document.querySelectorAll('.star');
    const ratingInput = document.getElementById('id_five_star_review');

    // åˆæœŸè¡¨ç¤ºè¨­å®šï¼ˆæ›´æ–°ãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã€æ—¢ã«è©•ä¾¡ãŒã‚ã‚Œã°æ˜Ÿã‚’å¡—ã‚‹ï¼‰
    const initialRating = ratingInput.value;
    if (initialRating) {
        updateStars(initialRating);
    }

    stars.forEach(star => {
        star.addEventListener('click', function() {
            const val = this.getAttribute('data-value');
            ratingInput.value = val;
            updateStars(val);
        });
    });

    function updateStars(val) {
        stars.forEach(s => {
            if (s.getAttribute('data-value') <= val) {
                s.innerText = 'â˜…'; s.style.color = '#f39c12';
            } else {
                s.innerText = 'â˜†'; s.style.color = '#ccc';
            }
        });
    }
</script>

<style>
    .tab-item:hover { background: #fff5f5; color: #d9534f !important; }
    input[type="text"], textarea { 
        width: 100%; 
        padding: 8px; 
        border: 2px solid #000; 
        box-sizing: border-box; 
    }
</style>
{% endblock %}