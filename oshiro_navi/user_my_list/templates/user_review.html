{% extends "user_base.html" %}
{% load static %}

{% block title %}{{ oshiro.oshiro_name }} - å£ã‚³ãƒŸ{% endblock %}

{% block content %}

<style>
.review-page-container {
    max-width: 800px;
    margin: 30px auto;
    background: #fff;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}



.wafu-sub-title {
    font-size: 1.2em;
    border-left: 5px solid #d4af37;
    padding-left: 10px;
    margin-bottom: 15px;
    color: #333;
    font-family: "Yuji Syuku", serif;
}

.avg-score-box {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
}

.avg-stars {
    font-size: 1.8em;
    color: #f39c12;
    font-weight: bold;
}

/* --- æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆï¼‰ --- */
.post-form-area {
    margin-bottom: 40px;
    background: #fafafa;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #eee;
}

.review-form .form-group {
    margin-bottom: 15px;
}

.review-form label {
    font-weight: bold;
    font-size: 0.85em;
    display: block;
    margin-bottom: 5px;
}

.review-form input[type="text"], 
.review-form textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
    font-family: sans-serif;
}

.btn-submit {
    background: #333;
    color: white;
    border: none;
    padding: 10px 25px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    width: auto;
}

/* --- å£ã‚³ãƒŸä¸€è¦§ã‚«ãƒ¼ãƒ‰ --- */
.review-card {
    border-bottom: 1px solid #eee;
    padding: 20px 0;
}

.review-card-inner {
    display: flex;
    gap: 15px;
}

.user-avatar img, .default-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
}

.review-main-content {
    flex: 1;
}

.review-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.85em;
    margin-bottom: 5px;
}

.user-name {
    color: #1e2a4a;
    font-weight: bold;
    text-decoration: none;
}

.review-stars {
    color: #f39c12;
    font-size: 0.9em;
    margin-bottom: 8px;
}

.review-card-title {
    display: block;
    font-size: 1.05em;
    margin-bottom: 5px;
}

.review-text {
    color: #444;
    line-height: 1.5;
    font-size: 0.95em;
}

.review-attached-image img {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    margin-top: 10px;
}

.my-review-actions {
    margin-top: 10px;
    text-align: right;
}

.btn-edit { color: #d4af37; text-decoration: none; font-size: 0.8em; font-weight: bold; }
.btn-delete { color: #999; text-decoration: none; font-size: 0.8em; margin-left: 10px; }

/* ====================================
    ã‚¹ãƒãƒ›æœ€é©åŒ–ï¼ˆ600pxä»¥ä¸‹ï¼‰
==================================== */
@media screen and (max-width: 600px) {
    .review-page-container {
        margin: 0;
        width: 100%;
        border-radius: 0;
    }

    .avg-stars {
    font-size: 1.2em;
    color: #f39c12;
    font-weight: bold;
}



    .info-content { padding: 20px 15px; }

    /* å£ã‚³ãƒŸã‚’è©°ã‚ã™ããªã„æ¨ªä¸¦ã³ã«ç¶­æŒ */
    .review-card-inner { gap: 10px; }
    
    .btn-submit { width: 100%; }
}

</style>
<div class="review-page-container">
    
    <div class="oshiro-image-header">
        {% if oshiro.info.oshiro_images or oshiro.oshiro_images %}
            <img src="{% if oshiro.info.oshiro_images %}{{ oshiro.info.oshiro_images.url }}{% else %}{{ oshiro.oshiro_images.url }}{% endif %}" alt="{{ oshiro.oshiro_name }}">
        {% else %}
             <div class="no-image">No Image Available</div>
        {% endif %}
        <div class="header-overlay">
            <h1>{{ oshiro.oshiro_name }}</h1>
        </div>
    </div>

    <div class="info-tabs">
        <a href="{% url 'usermy_list:oshiroinfo' oshiro.id %}" class="tab-item">ãŠåŸæƒ…å ±</a>
        <a href="{% url 'usermy_list:oshirobasicinfo' oshiro.id %}" class="tab-item">åŸºæœ¬æƒ…å ±</a>
        <a href="{% url 'usermy_list:oshiroreview' oshiro.id %}" class="tab-item active">å£ã‚³ãƒŸ</a>
        <a href="{% url 'usermy_list:oshiromap' oshiro.id %}" class="tab-item">å‘¨è¾ºMAP</a>
    </div>

    <div class="info-content">
        <div class="rating-summary">
            <h2 class="wafu-sub-title">ã¿ã‚“ãªã®è©•ä¾¡</h2>
            <div class="avg-score-box">
                <span class="avg-stars">â˜… {{ avg_score }}</span>
                <span class="total-count">ï¼ˆå…¨ {{ reviews.count }} ä»¶ï¼‰</span>
            </div>
        </div>

        <div class="post-form-area">
            {% if has_posted and not edit_mode %}
                <div class="already-posted-msg">
                    <p class="msg-bold">æ—¢ã«å£ã‚³ãƒŸã‚’æŠ•ç¨¿æ¸ˆã¿ã§ã™ã€‚</p>
                    <p class="msg-small">å†…å®¹ã‚’ä¿®æ­£ã—ãŸã„å ´åˆã¯ã€ã”è‡ªèº«ã®æŠ•ç¨¿ã«ã‚ã‚‹ã€Œæ›´æ–°ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            {% else %}
                <h3 class="form-title">
                    {% if edit_mode %}å£ã‚³ãƒŸã‚’æ›´æ–°ã™ã‚‹{% else %}ãŠåŸå£ã‚³ãƒŸã‚’æŠ•ç¨¿ã™ã‚‹{% endif %}
                </h3>
                
                <form method="post" enctype="multipart/form-data" novalidate action="?{% if edit_id %}edit_id={{ edit_id }}{% endif %}" class="review-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label>â€» ã‚¿ã‚¤ãƒˆãƒ«</label>
                        {{ form.review_title }}
                        {% if form.review_title.errors %}
                            <p class="error-msg">{{ form.review_title.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label>â€» è©•ä¾¡</label>
                        <div id="star-rating" class="star-rating-input">
                            <span class="star" data-value="1">â˜†</span><span class="star" data-value="2">â˜†</span><span class="star" data-value="3">â˜†</span><span class="star" data-value="4">â˜†</span><span class="star" data-value="5">â˜†</span>
                        </div>
                        <div class="hidden-field">{{ form.five_star_review }}</div>
                        {% if form.five_star_review.errors %}
                            <p class="error-msg">{{ form.five_star_review.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label>â€» ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                        {{ form.review_comments }}
                        {% if form.review_comments.errors %}
                            <p class="error-msg">{{ form.review_comments.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label>å†™çœŸ</label>
                        {{ form.review_image }}
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-submit">
                            {% if edit_mode %}æ›´æ–°ã‚’ä¿å­˜ã™ã‚‹{% else %}æŠ•ç¨¿ã™ã‚‹{% endif %}
                        </button>
                        {% if edit_mode %}
                            <a href="?" class="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
                        {% endif %}
                    </div>
                </form>
            {% endif %}
        </div>

        <h2 class="wafu-sub-title">æŠ•ç¨¿ã•ã‚ŒãŸãŠåŸå£ã‚³ãƒŸ</h2>
        <div class="review-list">
            {% for review in reviews %}
                <div class="review-card">
                    <div class="review-card-inner">
                        <div class="user-avatar">
                            <a href="{% url 'usermy_page:otherprofile' user_id=review.user.id %}" class="user-avatar-link">
                            {% if review.user.profile_image %}
                                <img  src="{{ review.user.profile_image.url }}" alt="avatar">
                            {% else %}
                                <div class="default-avatar">ğŸ‘¤</div>
                            {% endif %}
                            </a>
                        </div>

                        <div class="review-main-content">
                            <div class="review-meta">
                                <a href="{% url 'usermy_page:otherprofile' user_id=review.user.id %}" class="user-name">
                                    {{ review.user.account.username }}ã•ã‚“
                                </a>
                                <span class="post-date">{{ review.post_date_time|date:"Y.m.d" }}</span>
                            </div>

                            <div class="review-stars">
                                {% with ''|center:review.five_star_review as range %}
                                    {% for _ in range %}â˜…{% endfor %}
                                {% endwith %}
                            </div>

                            <strong class="review-card-title">{{ review.review_title }}</strong>
                            <p class="review-text">{{ review.review_comments|linebreaksbr }}</p>

                            {% if review.review_image %}
                                <div class="review-attached-image">
                                    <img src="{{ review.review_image.url }}" alt="review image">
                                </div>
                            {% endif %}

                            {% if review.user.account == user %}
                                <div class="my-review-actions">
                                    <a href="?edit_id={{ review.pk }}" class="btn-edit">æ›´æ–°ã™ã‚‹</a>
                                    <a href="{% url 'usermy_list:delete_review' review.pk %}" onclick="return confirm('æœ¬å½“ã«ã“ã®å£ã‚³ãƒŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')" class="btn-delete">å‰Šé™¤ã™ã‚‹</a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <p class="no-reviews">ã¾ã å£ã‚³ãƒŸã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endfor %}
        </div>

    </div>
</div>

<script>
    const stars = document.querySelectorAll('.star');
    const ratingInput = document.getElementById('id_five_star_review');

    if (ratingInput.value) {
        updateStars(ratingInput.value);
    }

    stars.forEach(star => {
        star.addEventListener('click', function() {
            const val = this.getAttribute('data-value');
            ratingInput.value = val;
            updateStars(val);
        });
    });

    function updateStars(val) {
        stars.forEach(s => {
            if (parseInt(s.getAttribute('data-value')) <= parseInt(val)) {
                s.innerText = 'â˜…'; s.style.color = '#f39c12';
            } else {
                s.innerText = 'â˜†'; s.style.color = '#ccc';
            }
        });
    }
</script>
{% endblock %}