{% extends 'admin_base.html' %}
{% load static %}
{% block title %}QRコード生成サンプル{% endblock %}
{% block content %}
<div class="content-container">
<style>
    

    input[type="text"], select { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; }
    .controls { display:flex; gap:8px; margin-top:10px; }
    button { padding:8px 12px; cursor:pointer; }
    #qrcode { margin-top:18px; padding:12px; border:1px solid #eee; display:inline-block; background:#fff; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

    <div class="home_content" id="qr_generetor">
        <h1>QRコードを生成する</h1>

<label for="text">QRにするテキスト・URL</label>
<input id="text" type="text" placeholder="例: https://example.com または 任意のテキスト" value="https://example.com">

<label for="size">サイズ (px)</label>
<select id="size">
    <option value="128">128</option>
    <option value="256" selected>256</option>
    <option value="512">512</option>
</select>

<label for="ec">誤り訂正レベル (Error Correction)</label>
<select id="ec">
    <option value="L">L - Low (7%)</option>
    <option value="M" selected>M - Medium (15%)</option>
    <option value="Q">Q - Quartile (25%)</option>
    <option value="H">H - High (30%)</option>
</select>

<div class="controls">
    <button id="generate">Generate</button>
    <button id="download" disabled>Download PNG</button>
    <button id="clear">Clear</button>
</div>

<div id="qrcode" aria-live="polite"></div>


<!-- QRコード生成用のJavaScript -->
<script>
let qr = null;

const elText = document.getElementById('text');
const elSize = document.getElementById('size');
const elEC = document.getElementById('ec');
const elGenerate = document.getElementById('generate');
const elDownload = document.getElementById('download');
const elClear = document.getElementById('clear');
const elQrcode = document.getElementById('qrcode');

function clearQrcode() {
    elQrcode.innerHTML = '';
    qr = null;
    elDownload.disabled = true;
}

function generateQrcode() {
    const text = elText.value.trim();
    if (!text) {
        alert('まずテキストまたはURLを入力してください。');
        return;
    }

    clearQrcode();

    const size = parseInt(elSize.value, 10) || 256;
    const ec = elEC.value || 'M';

    qr = new QRCode(elQrcode, {
        text: text,
        width: size,
        height: size,
        correctLevel: QRCode.CorrectLevel[ec]
    });

    setTimeout(() => {
        insertLogo(size);
        elDownload.disabled = false;
    }, 300);
}

function insertLogo(size) {
    const img = elQrcode.querySelector("img");
    if (!img) return;

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = size;
    canvas.height = size;

    const qrImage = new Image();
    qrImage.src = img.src;

    qrImage.onload = () => {
        ctx.drawImage(qrImage, 0, 0, size, size);

        const logo = document.getElementById("logo");
        const logoSize = size * 0.25; // ロゴの大きさ
        const x = (size - logoSize) / 2;
        const y = (size - logoSize) / 2;

        ctx.drawImage(logo, x, y, logoSize, logoSize);

        // QR画像をロゴ入りのキャンバス画像に差し替え
        img.src = canvas.toDataURL("image/png");
    };
}

function downloadQrcode() {
    const img = elQrcode.querySelector('img');
    if (!img) return;

    const a = document.createElement('a');
    a.href = img.src;
    a.download = 'qrcode.png';
    a.click();
}

elGenerate.addEventListener('click', generateQrcode);
elDownload.addEventListener('click', downloadQrcode);
elClear.addEventListener('click', clearQrcode);

elText.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        generateQrcode();
    }
});

window.addEventListener('load', () => {
    generateQrcode();
});
</script>

</div>
</div>
{% endblock %}


