{% extends 'admin_base.html' %}
{% load static %}
{% block title %}QRコード生成{% endblock %}
{% block content %}
<div class="content-container">
    <style>
        /* 横並びにするための設定 */
        .qr-wrapper {
            display: flex;
            align-items: flex-start; /* 上揃え */
            gap: 40px;               /* テーブルとQRの間の余白 */
            margin-top: 20px;
        }

        .input-section {
            flex: 1;                 /* 左側の幅を柔軟に */
            max-width: 600px;
        }

        input[type="text"], select { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; }
        
        /* QRコードエリアの見た目調整 */
        .qr-display-section {
            flex-shrink: 0;          /* QRコードが潰れないように固定 */
            text-align: center;
        }

        #qrcode { 
            padding:12px; 
            border:1px solid #eee; 
            display:inline-block; 
            background:#fff; 
            min-width: 128px;
            min-height: 128px;
        }

        .controls { margin-top: 20px; }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fff;
            padding: 24px;
            max-width: 510px;
            width: 100%;
            border-radius: 8px;
            line-height: 1.8;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 12px;
        }

        strong{
            color: #fa3232;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

        <h1>QRコードを生成する</h1>
        <hr style="width:80%; margin-bottom: 10px; margin-top: 10px;">


        <!-- 説明用ポップアップ -->
        <button id="openQrHelp" class="btn btn-update" style="margin-bottom: 16px;">
            このQRコードについて
        </button>
        <div id="qrHelpModal" class="modal-overlay">
            <div class="modal-content">
                <h2>このQRコードについて</h2>

                <p>
                    このQRコードは、<strong>利用者が現地で音声ガイドを聞くためのもの</strong>です。<br>
                    スマートフォンでQRコードを読み取ることで、音声ガイド一覧画面にアクセスできます。
                </p>

                <p>
                    お城・史跡・展示物など、<strong>音声ガイドを登録した場所に印刷して設置</strong>してください。<br>
                    「このQRコードを読み取って音声ガイドをお聞きください」
                    といった案内と一緒に掲示すると、利用者がスムーズに利用できます。
                </p>

                <p style="color:#555;">
                    ※ 本QRコードは印刷して掲示することを想定しています。
                </p>

                <div style="text-align: right; margin-top: 20px;">
                    <button id="closeQrHelp" class="btn btn-register">閉じる</button>
                </div>
            </div>
        </div>



        <div class="qr-wrapper">
            
            <div class="input-section">
                <table class="basic-info-table" border="1" cellpadding="8" cellspacing="0" style="width: 100%;">
                    <tr>
                        <th><label for="text">ユーザー側QR：URL</label></th>
                        <td>
                            <input style="background-color: #b2b2b2;" readonly id="text" type="text" value="http://127.0.0.1:8000/user/audio_guide/oshiro_list/">
                        </td>
                    </tr>
                    <tr>
                        <th><label for="size">サイズ (px)</label></th>
                        <td>
                            <select id="size">
                                <option value="128">128</option>
                                <option value="256" selected>256</option>
                                <option value="512">512</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th><label for="ec">誤り訂正レベル</label></th>
                        <td>
                            <select id="ec">
                                <option value="L">L - Low (7%)</option>
                                <option value="M" selected>M - Medium (15%)</option>
                                <option value="Q">Q - Quartile (25%)</option>
                                <option value="H">H - High (30%)</option>
                            </select>
                        </td>
                    </tr>
                </table>

                <div class="controls">
                    <button class="btn btn-register" id="generate">生成</button>
                    <button style="text-align: center;" class="btn btn-update" id="download" disabled><i class="material-symbols-outlined">download</i>ダウンロード</button>
                    <button style="display: none;" id="clear">Clear</button>
                </div>
            </div>

            <div class="qr-display-section">
                <p style="margin-top: 0; font-weight: bold;">生成されたQRコード</p>
                <div id="qrcode" aria-live="polite"></div>
            </div>


    <!-- QRコード生成用のJavaScript -->
    <script>
    let qr = null;

    const elText = document.getElementById('text');
    const elSize = document.getElementById('size');
    const elEC = document.getElementById('ec');
    const elGenerate = document.getElementById('generate');
    const elDownload = document.getElementById('download');
    const elClear = document.getElementById('clear');
    const elQrcode = document.getElementById('qrcode');

    function clearQrcode() {
        elQrcode.innerHTML = '';
        qr = null;
        elDownload.disabled = true;
    }

    function generateQrcode() {
        const text = elText.value.trim();
        if (!text) {
            alert('まずテキストまたはURLを入力してください。');
            return;
        }

        clearQrcode();

        const size = parseInt(elSize.value, 10) || 256;
        const ec = elEC.value || 'M';

        qr = new QRCode(elQrcode, {
            text: text,
            width: size,
            height: size,
            correctLevel: QRCode.CorrectLevel[ec]
        });

        setTimeout(() => {
            insertLogo(size);
            elDownload.disabled = false;
        }, 300);
    }

    function insertLogo(size) {
        const img = elQrcode.querySelector("img");
        if (!img) return;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        canvas.width = size;
        canvas.height = size;

        const qrImage = new Image();
        qrImage.src = img.src;

        qrImage.onload = () => {
            ctx.drawImage(qrImage, 0, 0, size, size);

            const logo = document.getElementById("logo");
            const logoSize = size * 0.25; // ロゴの大きさ
            const x = (size - logoSize) / 2;
            const y = (size - logoSize) / 2;

            ctx.drawImage(logo, x, y, logoSize, logoSize);

            // QR画像をロゴ入りのキャンバス画像に差し替え
            img.src = canvas.toDataURL("image/png");
        };
    }

    function downloadQrcode() {
        const img = elQrcode.querySelector('img');
        if (!img) return;

        const a = document.createElement('a');
        a.href = img.src;
        a.download = 'qrcode.png';
        a.click();
    }

    elGenerate.addEventListener('click', generateQrcode);
    elDownload.addEventListener('click', downloadQrcode);
    elClear.addEventListener('click', clearQrcode);

    elText.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            generateQrcode();
        }
    });

    window.addEventListener('load', () => {
        generateQrcode();
    });


    const openBtn = document.getElementById("openQrHelp");
    const closeBtn = document.getElementById("closeQrHelp");
    const modal = document.getElementById("qrHelpModal");

    openBtn.addEventListener("click", () => {
        modal.style.display = "flex";
    });

    closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
    });

    // 背景クリックで閉じる
    modal.addEventListener("click", (e) => {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });
    </script>

</div>
{% endblock %}


