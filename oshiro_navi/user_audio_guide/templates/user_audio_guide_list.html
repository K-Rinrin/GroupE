{% extends "user_base.html" %}
{% load static %}

{% block title %}éŸ³å£°ã‚¬ã‚¤ãƒ‰ä¸€è¦§{% endblock %}

{% block extra_css %}
<style>
    /* å…¨ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    .guide-page-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        font-family: 'Helvetica Neue', Arial, sans-serif;
        background-color: #f0f2f5;
        min-height: 100vh;
    }

    /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰ï¼ˆã¤ã‚€ãï¼‰ */
    .voice-chat-card {
        width: 100%;
        max-width: 400px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 30px;
    }

    .voice-chat-card-header {
        background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        padding: 20px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid white;
        object-fit: cover;
        background-color: #eee;
    }

    .info-group {
        margin-left: 15px;
    }

    .oshiro_name {
        font-weight: bold;
        font-size: 1.2rem;
        color: #333;
        display: flex;
        align-items: center;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #4cd137;
        margin-left: 8px;
        box-shadow: 0 0 5px #4cd137;
    }

    /* éŸ³å£°å†ç”Ÿã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .voice-chat-card-body {
        padding: 20px;
    }

    .guide-item {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 5px solid #a1c4fd;
    }

    .guide-title {
        font-weight: bold;
        margin-bottom: 8px;
        color: #444;
        display: block;
    }

    .audio-player {
        width: 100%;
        height: 40px;
        margin-top: 5px;
    }

    /* ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼è¨­å®šã‚¨ãƒªã‚¢ï¼ˆæŠ˜ã‚ŠãŸãŸã¿é¢¨ï¼‰ */
    .settings-area {
        font-size: 0.8rem;
        color: #666;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed #ccc;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }

    select, input {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ddd;
        margin-top: 5px;
    }

    .btn-play {
        background: #a1c4fd;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        width: 100%;
        margin-top: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.3s;
    }

    .btn-play:hover {
        background: #89b4f7;
    }
</style>
{% endblock %}

{% block content %}
<div class="guide-page-container">
    <div class="voice-chat-card">
        <div class="voice-chat-card-header">
            <img src="{% static 'image/é¶´ãƒ¶åŸ12345.jpg' %}" class="avatar">
            <div class="info-group">
                <div class="oshiro_name">{{ oshiro.oshiro_name }}ï¼šéŸ³å£°ã‚¬ã‚¤ãƒ‰ <span class="status-dot"></span></div>
                <small style="color: #666;">éå…¬å¼ã‚¬ã‚¤ãƒ‰ãƒœã‚¤ã‚¹ï¼šVoiceVox</small>
            </div>
        </div>

        <div class="voice-chat-card-body">
            <div class="guide-item">
                <span class="guide-title">éŸ³å£°ã‚¬ã‚¤ãƒ‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</span>
                <button style="display: none" id="speak" class="btn-play">å†ç”Ÿã™ã‚‹</button>
                <audio id="player" class="audio-player" controls></audio>
                
                <div class="settings-area">
                    <label>ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´: <select  id="speaker"></select></label>
                </div>
            </div>

            <hr style="border: none; border-top: 1px solid #000000; margin: 20px 0;">

            <h5 style="margin-bottom: 15px; color: #555;">ğŸ“œ ç™»éŒ²æ¸ˆã¿ã‚¬ã‚¤ãƒ‰</h5>
            {% for guide in rows %}
            <div class="guide-item">
                <span class="guide-title">ğŸ”Š{{ guide.title }}</span>
                <p style="font-size: 0.9rem; color: #777;">{{ guide.guide_explanation}}</p>
                <button class="btn-play btn-inline-play" 
                        data-text="{{ guide.title }}ã€‚{{ guide.guide_explanation }}" 
                        style="padding: 5px 10px; font-size: 0.8rem; width: auto; margin-bottom: 10px;">
                    éŸ³å£°ã‚¬ã‚¤ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹
                </button>
                <hr style="border: none; border-top: 1px solid #000000; margin: 20px 0;">
            </div>
            {% empty %}
            <p style="text-align: center; color: #999;">ã‚¬ã‚¤ãƒ‰ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
            {% endfor %}
        </div>
        
    </div>
</div>

<script>

const BASE = "http://127.0.0.1:50021";
// å¯¾è±¡ã¨ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã®ãƒªã‚¹ãƒˆ
const TARGET_CHARACTERS = ["æ˜¥æ—¥éƒ¨ã¤ã‚€ã", "ç„é‡æ­¦å®"];
const DEFAULT_STYLE_ID = 8; // ã¤ã‚€ããƒãƒ¼ãƒãƒ«
// ç™»éŒ²æ¸ˆã¿ã‚¬ã‚¤ãƒ‰ã®å†ç”Ÿãƒœã‚¿ãƒ³ã«å¯¾ã™ã‚‹å‡¦ç†
document.addEventListener("click", (e) => {
    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ãŒ 'btn-inline-play' ã‚¯ãƒ©ã‚¹ã‚’æŒã£ã¦ã„ãŸå ´åˆ
    if (e.target && e.target.classList.contains("btn-inline-play")) {
        const textToSpeak = e.target.getAttribute("data-text");
        const speakerId = document.getElementById("speaker").value; // ç¾åœ¨é¸æŠä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«IDï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã¤ã‚€ãï¼‰
        
        // å†ç”Ÿä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãŸã‚ã«ãƒœã‚¿ãƒ³ã‚’å°‘ã—å¤‰ãˆã‚‹ï¼ˆä»»æ„ï¼‰
        const originalText = e.target.textContent;
        e.target.textContent = "ç”Ÿæˆä¸­...";
        e.target.disabled = true;

        synthesize(textToSpeak, speakerId).then(() => {
            e.target.textContent = originalText;
            e.target.disabled = false;
        }).catch(() => {
            e.target.textContent = "ã‚¨ãƒ©ãƒ¼";
            e.target.disabled = false;
        });
    }
});

async function loadSpeakers() {
    try {
        const res = await fetch(`${BASE}/speakers`);
        if (!res.ok) throw new Error("speakers API failed");
        const data = await res.json();

        const sel = document.getElementById("speaker");
        sel.innerHTML = "";
        
        // æŒ‡å®šã—ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŸã¡ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã™ã¹ã¦è¿½åŠ 
        data.forEach((character) => {
            if (TARGET_CHARACTERS.includes(character.name)) {
                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆoptgroupï¼‰ã™ã‚‹ã¨è¦‹ã‚„ã™ããªã‚Šã¾ã™
                const group = document.createElement("optgroup");
                group.label = character.name;

                character.styles.forEach((st) => {
                    const opt = document.createElement("option");
                    opt.value = st.id;
                    opt.textContent = `${character.name}ï¼ˆ${st.name}ï¼‰`;
                    group.appendChild(opt);
                });
                sel.appendChild(group);
            }
        });

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®šï¼ˆã¤ã‚€ããƒãƒ¼ãƒãƒ«ãŒã‚ã‚Œã°é¸æŠï¼‰
        sel.value = String(DEFAULT_STYLE_ID);

    } catch (e) {
        console.error("VOICEVOX connection failed:", e);
    }
}

async function synthesize(text, speaker) {
    const qRes = await fetch(`${BASE}/audio_query?text=${encodeURIComponent(text)}&speaker=${speaker}`, { method: "POST" });
    const query = await qRes.json();
    const sRes = await fetch(`${BASE}/synthesis?speaker=${speaker}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(query),
    });
    const blob = await sRes.blob();
    const url = URL.createObjectURL(blob);
    const audio = document.getElementById("player");
    audio.src = url;
    // audio.play();  ã‚ªãƒ¼ãƒˆå†ç”Ÿ
}

document.getElementById("speak").addEventListener("click", () => {
    const text = document.getElementById("text").value;
    const speaker = document.getElementById("speaker").value;
    synthesize(text, speaker);
});

loadSpeakers();
</script>
{% endblock %}