{% extends "user_base.html" %}
{% load static %}

{% block title %}éŸ³å£°ã‚¬ã‚¤ãƒ‰ä¸€è¦§{% endblock %}


{% block content %}
<div class="guide-page-container">
    <div class="voice-chat-card">
        <div class="voice-chat-card-header">
            <img src="{{ oshiro.oshiro_images.url }}" class="avatar" alt="{{ oshiro.oshiro_name }}ã®ç”»åƒ">
            <div class="info-group">
                <div class="oshiro_name">{{ oshiro.oshiro_name }} ã‚¬ã‚¤ãƒ‰ <span class="status-dot"></span></div>
                <!-- åˆ©ç”¨è¦ç´„ã«ã®ã£ã¨ã‚Šã¾ã—ãŸ -->
                <small id="creditText" style="color: rgba(255,255,255,0.9);">VOICEVOX:ãšã‚“ã ã‚‚ã‚“</small>
            </div>
        </div>

        <div class="voice-chat-card-body">
            <div class="guide-item" style="border-left: 5px solid #56ab2f;">
                <div class="help-header" onclick="openHelp()">
                    <span class="guide-title">å†ç”Ÿè¨­å®š</span>
                    <span class="material-symbols-outlined" style="cursor: pointer;">help</span><small>éŸ³å£°ã‚¬ã‚¤ãƒ‰ã®ä½¿ã„æ–¹</small>
                </div>
                <!-- help ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”¨ -->
                <div id="helpModal" class="modal-overlay" onclick="closeHelp()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <h3><span class="material-symbols-outlined" style="cursor: pointer;">help</span>
                            éŸ³å£°ã‚¬ã‚¤ãƒ‰ã®ä½¿ã„æ–¹
                        </h3>
                        <ul class="help-list">
                            <li><b>1. ã‚¬ã‚¤ãƒ‰è©±è€…é¸æŠ:</b> ãŠå¥½ã¿ã®å£°ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</li>
                            <li><b>2. ã‚¬ã‚¤ãƒ‰ã‚’é¸ã¶:</b> å„ã‚¹ãƒãƒƒãƒˆã®ã€Œã“ã®ã‚¬ã‚¤ãƒ‰ã‚’è´ãã€ã‚’æŠ¼ã™ã¨éŸ³å£°ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚</li>
                            <li><b>3. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œ:</b> ç”ŸæˆãŒçµ‚ã‚ã‚‹ã¨ã€å†ç”Ÿãƒ»ä¸€æ™‚åœæ­¢ã‚„é€Ÿåº¦èª¿æ•´ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</li>
                        </ul>
                        <button class="btn-close" onclick="closeHelp()">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
                <!-- ãƒ–ãƒ©ã‚¦ã‚¶ã”ã¨ã«å¤–è¦³ãŒæ±ºã¾ã£ã¦ã„ã‚‹ã€€audio -->
                <!-- <audio id="audioPlayer" class="audio-player" controls></audio> -->
                <audio id="audioPlayer" style="display: none;"></audio>
                <div class="custom-player-container">
                    <div class="player-main-row">
                        <button id="playPauseBtn" class="play-toggle-btn" disabled><span class="material-symbols-outlined">
                            play_circle
                            </span>
                        </button>
                        <div class="progress-wrapper">
                            <div class="time-display">
                                <span id="currentTime">0:00</span> / <span id="durationTime">0:00</span>
                            </div>
                            <input type="range" id="progressSlider" min="0" max="100" value="0" disabled>
                        </div>
                    </div>

                    <div class="player-sub-row">
                        <div class="volume-group">
                            <span class="material-symbols-outlined">
                                sound_detection_loud_sound
                            </span>
                            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" disabled>
                        </div>
                        <div class="speed-group">
                            <label>å†ç”Ÿé€Ÿåº¦: 
                                <select id="speedSelect" disabled>
                                    <option value="0.5">0.5x</option>
                                    <option value="0.75">0.75x</option>
                                    <option value="1.0" selected>1.0x (æ¨™æº–)</option>
                                    <option value="1.25">1.25x</option>
                                    <option value="1.5">1.5x</option>
                                    <option value="2.0">2.0x</option>
                                </select>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="loadingStatus" class="loading-text">
                    <span id="loadingMsg">ãšã‚“ã ã‚‚ã‚“ãŒæº–å‚™ä¸­ãªã®ã ...</span>
                </div>
                
                <div class="settings-area">
                    <label>ã‚¬ã‚¤ãƒ‰è©±è€…é¸æŠ: 
                        <select id="speakerSelect">
                            <option value="3">ãƒãƒ¼ãƒãƒ«</option>
                        </select>
                    </label>
                </div>
            </div>
            <h5 style="margin-bottom: 15px; color: #555;">ğŸ“œ éŸ³å£°ã‚¬ã‚¤ãƒ‰</h5>
            <hr style="width:100%; margin-bottom: 10px; margin-top: 10px;">


            
            {% for guide in rows %}
            <div class="guide-item">
                <span class="guide-title"><span class="material-symbols-outlined">
                    sound_detection_loud_sound
                    </span> {{ guide.title }}
                </span>
                
                <details class="guide-details">
                    <summary class="guide-summary">éŸ³å£°ã‚¬ã‚¤ãƒ‰ã‚’è¦‹ã‚‹ â–¼</summary>
                    <p class="guide-text">{{ guide.guide_explanation }}</p>
                </details>
                <button class="btn-play" 
                        onclick="generateAndPlay('{{ guide.title }}ã€‚{{ guide.guide_explanation|escapejs }}', this)">
                    ã“ã®ã‚¬ã‚¤ãƒ‰ã‚’è´ã
                </button>
            </div>
            <hr style="width:100%; margin-bottom: 10px; margin-top: 10px;">
            {% empty %}
            <p style="text-align: center; color: #999;">ã‚¬ã‚¤ãƒ‰ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
            {% endfor %}
        </div>
    </div>
</div>



<script>
    const API_KEY = "Z8f9i-e-T21_388"; 
    const audioPlayer = document.getElementById('audioPlayer');
    const loadingStatus = document.getElementById('loadingStatus');
    const creditText = document.getElementById('creditText'); 
    const loadingMsg = document.getElementById('loadingMsg'); 
    const playPauseBtn = document.getElementById('playPauseBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    const progressSlider = document.getElementById('progressSlider');
    const currentTimeDisplay = document.getElementById('currentTime');
    const durationTimeDisplay = document.getElementById('durationTime');
    const speedSelect = document.getElementById('speedSelect');

// ç§’ã‚’ã€Œåˆ†:ç§’ã€å½¢å¼ã«å¤‰æ›
function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return `${m}:${s < 10 ? '0' : ''}${s}`;
}

// éŸ³å£°ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ç·æ™‚é–“ã‚’è¡¨ç¤º
audioPlayer.addEventListener('loadedmetadata', () => {
    durationTimeDisplay.innerText = formatTime(audioPlayer.duration);
    progressSlider.max = Math.floor(audioPlayer.duration);
});

// å†ç”Ÿä¸­ã«ãƒãƒ¼ã¨æ™‚é–“ã‚’æ›´æ–°
audioPlayer.addEventListener('timeupdate', () => {
    progressSlider.value = Math.floor(audioPlayer.currentTime);
    currentTimeDisplay.innerText = formatTime(audioPlayer.currentTime);
    
    // ãƒãƒ¼ã®é€²ã¿å…·åˆ
    const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    progressSlider.style.background = `linear-gradient(to right, #56ab2f ${percent}%, #ddd ${percent}%)`;
});

// ãƒãƒ¼ã‚’å‹•ã‹ã—ã¦å¥½ããªå ´æ‰€ã«ã‚¹ã‚­ãƒƒãƒ—
progressSlider.addEventListener('input', () => {
    audioPlayer.currentTime = progressSlider.value;
});

// å†ç”Ÿé€Ÿåº¦ã®å¤‰æ›´
speedSelect.addEventListener('change', () => {
    audioPlayer.playbackRate = parseFloat(speedSelect.value);
});

// éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
volumeSlider.addEventListener('input', (e) => {
    audioPlayer.volume = e.target.value;
});




playPauseBtn.addEventListener('click', () => {
    if (audioPlayer.paused) {
        audioPlayer.play();
        playPauseBtn.innerHTML = "<span class=\"material-symbols-outlined\">pause_circle</span>"; // ä¸€æ™‚åœæ­¢ã‚¢ã‚¤ã‚³ãƒ³
        playPauseBtn.classList.remove('paused');
        playPauseBtn.classList.add('playing');
    } else {
        audioPlayer.pause();
        playPauseBtn.innerHTML = "<span class=\"material-symbols-outlined\">play_circle</span>"; // å†ç”Ÿã‚¢ã‚¤ã‚³ãƒ³
        playPauseBtn.classList.remove('playing');
        playPauseBtn.classList.add('paused');
    }
});

// éŸ³å£°ãŒæœ€å¾Œã¾ã§å†ç”Ÿã—çµ‚ã‚ã£ãŸã‚‰å†ç”Ÿãƒœã‚¿ãƒ³ã«æˆ»ã™
audioPlayer.addEventListener('ended', () => {
    playPauseBtn.innerHTML = "<span class=\"material-symbols-outlined\">play_circle</span>";
    playPauseBtn.classList.remove('playing');
    playPauseBtn.classList.add('paused');
});

// éŸ³å£°çµ‚äº†æ™‚
audioPlayer.addEventListener('ended', () => {
    playPauseBtn.innerHTML = "<span class=\"material-symbols-outlined\">play_circle</span>";
    progressSlider.value = 0;
});

// æ“ä½œã‚’ç„¡åŠ¹ãƒ»æœ‰åŠ¹ã«ã™ã‚‹é–¢æ•°
function setPlayerEnabled(enabled) {
    const controls = [
        document.getElementById('playPauseBtn'),
        document.getElementById('progressSlider'),
        document.getElementById('volumeSlider'),
        document.getElementById('speedSelect')
    ];
    
    controls.forEach(control => {
        control.disabled = !enabled;
    });
}

async function generateAndPlay(text, button) {
    const speakerId = document.getElementById('speakerSelect').value;
    const originalText = button.innerText;
    
    // ä¸€æ—¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨ä½“ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ–°ã—ã„éŸ³å£°ã‚’ç”Ÿæˆä¸­ï¼‰
    setPlayerEnabled(false);
    
    button.disabled = true;
    button.innerText = "ç”Ÿæˆä¸­...";
    loadingStatus.style.display = "block";

    const url = `https://deprecatedapis.tts.quest/v2/voicevox/audio/?key=${API_KEY}&speaker=${speakerId}&text=${encodeURIComponent(text)}`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("APIã‚¨ãƒ©ãƒ¼");

        const blob = await response.blob();
        const audioUrl = URL.createObjectURL(blob);
        
        audioPlayer.src = audioUrl;
        
        // éŸ³å£°ã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰æ“ä½œå¯èƒ½ã«ã™ã‚‹
        audioPlayer.oncanplaythrough = () => {
            setPlayerEnabled(true);
            audioPlayer.play();
            playPauseBtn.innerHTML = "<span class=\"material-symbols-outlined\">pause_circle</span>"; // å†ç”Ÿé–‹å§‹æ™‚ã«ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
        };

    } catch (error) {
        console.error(error);
        alert("éŸ³å£°ã®ç”Ÿæˆã«å¤±æ•—ã—ãŸã®ã ã€‚");
        setPlayerEnabled(false); // å¤±æ•—æ™‚ã¯ç„¡åŠ¹ã®ã¾ã¾
    } finally {
        button.disabled = false;
        button.innerText = originalText;
        loadingStatus.style.display = "none";
    }
}

    // 1. ç‰¹å®šã®3äººï¼ˆãƒãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã®ã¿ã‚’ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã‚»ãƒƒãƒˆ
    async function fetchSpeakers() {
        try {
            const response = await fetch(`https://deprecatedapis.tts.quest/v2/voicevox/speakers/?key=${API_KEY}`);
            const data = await response.json();
            
            const targets = ["æ˜¥æ—¥éƒ¨ã¤ã‚€ã", "ç„é‡æ­¦å®", "ãšã‚“ã ã‚‚ã‚“"];
            const select = document.getElementById('speakerSelect');
            select.innerHTML = '';

            targets.forEach(name => {
                const speaker = data.find(s => s.name === name);
                if (speaker) {
                    const normalStyle = speaker.styles.find(style => style.name === "ãƒãƒ¼ãƒãƒ«") || speaker.styles[0];
                    const option = document.createElement('option');
                    option.value = normalStyle.id;
                    option.textContent = speaker.name;
                    // ã‚«ã‚¹ã‚¿ãƒ å±æ€§ã¨ã—ã¦åå‰ã‚’ä¿å­˜ã—ã¦ãŠã
                    option.setAttribute('data-name', speaker.name);
                    select.appendChild(option);
                }
            });

            // é¸æŠãŒå¤‰ã‚ã£ãŸæ™‚ã«è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
            select.addEventListener('change', updateSpeakerUI);
            // åˆæœŸè¡¨ç¤ºã‚’åæ˜ 
            updateSpeakerUI();

        } catch (e) { console.error("å–å¾—å¤±æ•—", e); }
    }

    // 2. éŸ³å£°ç”Ÿæˆã¨å†ç”Ÿ
    function updateSpeakerUI() {
        const select = document.getElementById('speakerSelect');
        const selectedName = select.options[select.selectedIndex].getAttribute('data-name');
        
        // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¡¨è¨˜ã®æ›´æ–°
        creditText.innerText = `VOICEVOX:${selectedName}`;
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ›´æ–°ï¼ˆèªå°¾ã‚’ãã‚Œã£ã½ãï¼‰
        if (selectedName === "ãšã‚“ã ã‚‚ã‚“") {
            loadingMsg.innerText = "ãšã‚“ã ã‚‚ã‚“ãŒæº–å‚™ä¸­ãªã®ã ï¼";
        } else if (selectedName === "æ˜¥æ—¥éƒ¨ã¤ã‚€ã") {
            loadingMsg.innerText = "æ˜¥æ—¥éƒ¨ã¤ã‚€ããŒæº–å‚™ä¸­ã ã‚ˆï¼";
        } else {
            loadingMsg.innerText = `${selectedName}ãŒæº–å‚™ä¸­ã§ã™ã€‚`;
        }
    }



    fetchSpeakers();

function openHelp() {
    document.getElementById('helpModal').style.display = 'flex';
}

function closeHelp() {
    document.getElementById('helpModal').style.display = 'none';
}

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®Escã‚­ãƒ¼ã§ã‚‚é–‰ã˜ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆè¦ªåˆ‡è¨­è¨ˆï¼‰
window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeHelp();
});
</script>
{% endblock %}